#!/usr/bin/env sh

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e

# Generate password file
# sourcing the file directly is broken with quotes
SATELLITE_MQTT_PASSWORD=$(grep '^SATELLITE_MQTT_PASSWORD=' ./passwords.env) && export "${SATELLITE_MQTT_PASSWORD?}"

podman run -i --rm --cgroups=no-conmon --volume=./satellite:/pass_tmp_dir:Z "${ECLIPSE_MOSQUITTO_IMAGE}" sh << EOF
    touch /pass_tmp_dir/mosquitto_passwd
    chmod 0600 /pass_tmp_dir/mosquitto_passwd
    chown mosquitto:mosquitto /pass_tmp_dir/mosquitto_passwd
    mosquitto_passwd -b /pass_tmp_dir/mosquitto_passwd $SATELLITE_MQTT_USERNAME $SATELLITE_MQTT_PASSWORD
EOF

# Generate config
cat << EOF > ./satellite/mosquitto.conf
password_file /mosquitto_passwd
allow_anonymous false
listener $SATELLITE_MQTT_PORT
EOF

