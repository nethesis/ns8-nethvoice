#!/usr/bin/env sh

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e

# Generate password file
# sourcing the file directly is broken with quotes
SATELLITE_MQTT_PASSWORD=$(grep '^SATELLITE_MQTT_PASSWORD=' ./passwords.env) && export "${SATELLITE_MQTT_PASSWORD?}"

podman run -it docker.io/library/eclipse-mosquitto sh -c << EOF > ./satellite/mosquitto_passwd
    touch /mosquitto_passwd
    chmod 0700 /mosquitto_passwd
    mosquitto_passwd -b /mosquitto_passwd $SATELLITE_MQTT_USERNAME $SATELLITE_MQTT_PASSWORD
    cat /mosquitto_passwd
EOF

# Generate config
cat << EOF > ./satellite/mosquitto.conf
password_file /mosquitto_passwd
allow_anonymous false
listener $SATELLITE_MQTT_PORT
EOF
