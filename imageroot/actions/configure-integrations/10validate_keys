#!/usr/bin/env python3

#
# Copyright (C) 2024 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys
import os
import agent

agent.set_weight(os.path.basename(__file__), 0) # Validation step, no task progress at all

request = json.load(sys.stdin)


# Check if transcription is enabled (integrations)
call_transcription = request.get('satellite_call_transcription_enabled', 'False') == 'True'
voicemail_transcription = request.get('satellite_voicemail_transcription_enabled', 'False') == 'True'
deepgram_key = request.get('deepgram_api_key', '').strip()

# If any transcription is enabled, Deepgram API key is required
if (call_transcription or voicemail_transcription) and not deepgram_key:
    agent.set_status('validation-failed')
    json.dump([{
        'field': 'deepgram_api_key',
        'parameter': 'deepgram_api_key',
        'value': '',
        'error': 'deepgram_api_key_required_for_transcription'
    }], fp=sys.stdout)
    sys.exit(2)

# Validate Deepgram API key format (alphanumeric only)
if deepgram_key and not deepgram_key.isalnum():
    agent.set_status('validation-failed')
    json.dump([{
        'field': 'deepgram_api_key',
        'parameter': 'deepgram_api_key',
        'value': deepgram_key,
        'error': 'deepgram_api_key_invalid_format'
    }], fp=sys.stdout)
    sys.exit(2)

# Validate OpenAI API key format if provided (alphanumeric, dash, underscore)
openai_key = request.get('openai_api_key', '').strip()
if openai_key:
    import re
    if not re.match(r'^[a-zA-Z0-9\-_]+$', openai_key):
        agent.set_status('validation-failed')
        json.dump([{
            'field': 'openai_api_key',
            'parameter': 'openai_api_key',
            'value': openai_key,
            'error': 'openai_api_key_invalid_format'
        }], fp=sys.stdout)
        sys.exit(2)
