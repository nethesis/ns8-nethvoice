#!/usr/bin/env python3

#
# Copyright (C) 2026 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import os
import sys


def parse_port(value: str):
    if not value.isdigit():
        return None
    port = int(value)
    if port < 1 or port > 65535:
        return None
    return port


def extract_name(env_var_name: str) -> str:
    return env_var_name.split("_PORT", 1)[0].lower()


ports = []
for name, value in os.environ.items():
    if not name.endswith("_PORT"):
        continue
    if value is None or value == "":
        continue
    port = parse_port(value)
    if port is None:
        continue
    ports.append({"name": extract_name(name), "port": port})

ports.sort(key=lambda item: (item["name"], str(item["port"])))
json.dump(ports, fp=sys.stdout)
