#!/usr/bin/env python3

#
# Copyright (C) 2024 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import json
import sys
import os
import agent

agent.set_weight(os.path.basename(__file__), 0) # Validation step, no task progress at all

request = json.load(sys.stdin)

# Check if hotel module is enabled
if request.get('nethvoice_hotel', 'False') == 'False':
    # If disabled, no validation needed
    sys.exit(0)

# Check if subscription is valid for hotel module
rdb = agent.redis_connect(privileged=False)
subscription = rdb.hgetall('cluster/subscription')

if not subscription or subscription.get('provider') != 'nsent':
    agent.set_status('validation-failed')
    json.dump([{
        'field': 'nethvoice_hotel',
        'parameter': 'subscription',
        'value': request.get('nethvoice_hotel'),
        'error': 'subscription_required_for_hotel'
    }], fp=sys.stdout)
    sys.exit(2)

# If FIAS is configured, validate address and port
if request.get('nethvoice_hotel_fias_address', ''):
    if not request.get('nethvoice_hotel_fias_port', ''):
        agent.set_status('validation-failed')
        json.dump([{
            'field': 'nethvoice_hotel_fias_port',
            'parameter': 'nethvoice_hotel_fias_port',
            'value': '',
            'error': 'fias_port_required_when_address_set'
        }], fp=sys.stdout)
        sys.exit(2)

if request.get('nethvoice_hotel_fias_port', ''):
    if not request.get('nethvoice_hotel_fias_address', ''):
        agent.set_status('validation-failed')
        json.dump([{
            'field': 'nethvoice_hotel_fias_address',
            'parameter': 'nethvoice_hotel_fias_address',
            'value': '',
            'error': 'fias_address_required_when_port_set'
        }], fp=sys.stdout)
        sys.exit(2)
