#!/usr/bin/env python3

#
# Copyright (C) 2024 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import sys
import agent

# Read the env file to get updated environment variables
env = agent.read_envfile('environment')

# Configure middleware routes if middleware environment variables are set
if (env.get('NETHVOICE_MIDDLEWARE_PORT') and 
    env.get('NETHVOICE_HOST') and 
    env.get('NETHCTI_UI_HOST')):

    # CTI Wizard
    # Configure middleware API route on NETHVOICE_HOST
    agent.set_route({
        'instance': env['MODULE_ID'] + '-middleware-server-api',
        'url':  'http://127.0.0.1:' + env["NETHVOICE_MIDDLEWARE_PORT"],
        'http2https':  env["TRAEFIK_HTTP2HTTPS"] == "true",
        'host': env["NETHVOICE_HOST"],
        'path': '/api',
        'strip_prefix': True,
        'headers': {
            'response': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Credentials': "true",
                'Access-Control-Allow-Headers': '*'
            }
        }
    },
    error_passthrough=False
    )

    # CTI client
    # Configure middleware API route on NETHCTI_UI_HOST 
    agent.set_route({
        'instance': env['MODULE_ID'] + '-middleware-cti-server-api',
        'url':  'http://127.0.0.1:' + env["NETHVOICE_MIDDLEWARE_PORT"],
        'http2https':  env["TRAEFIK_HTTP2HTTPS"] == "true",
        'host': env["NETHCTI_UI_HOST"],
        'path': '/api',
        'strip_prefix': True,
        'headers': {
            'response': {
                'Access-Control-Allow-Origin': '*',
                'Access-Control-Allow-Credentials': "true",
                'Access-Control-Allow-Headers': '*'
            }
        }
    },
    error_passthrough=False
    )

    print("Middleware routes configured successfully", file=sys.stderr)
else:
    print("Middleware environment variables not set, skipping route configuration", file=sys.stderr)
