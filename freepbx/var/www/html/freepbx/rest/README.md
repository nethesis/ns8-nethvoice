# REST API

Simple REST API framework for NethVoice. This is based on Slim framework: <http://www.slimframework.com/docs/> API design inspired by <http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api>

The code must be installed under `/var/www/html/freepbx/rest` directory.

## Adding modules

To add a new module, create a php file inside the `modules` directory. All modules automatically have access to all FreePBX variables like `$db` and `$astman`.

Example:

```
<?php
use \Psr\Http\Message\ServerRequestInterface as Request;
use \Psr\Http\Message\ResponseInterface as Response;

require_once('/var/www/html/freepbx/admin/modules/_module_/functions.inc.php');

$app->get('/magic/list', function (Request $request, Response $response, $args) {
    global $db;
    global $astman;

    ... do your magic here ..

    return $response->withJson($result);
});
```

## Configuration

config.inc.php configuration file is generated by NethServer templates. Here there is an example:

```
<?php

$config = [
    'settings' => [
        'secretkey' => '1234',
        'cti_config_path' => '/etc/nethcti'
    ],
];

```


## Environment variables

NethServer 8 version expect some configuration to be passed as environment variables

### Local networks
Local networks are required to properly do NAT with extensions in local networks. It is possible to configure it with the environment variable `NETHVOICE_HOST_LOCAL_NETWORKS` that contains a JSON with an array of local networks, for instance:
```
{
    [
        "network":"192.168.5.0",
        "ip":"192.168.5.14",
        "netmask":"255.255.255.0",
        "gateway":"192.168.5.1"
    ],
    [
        "network":"10.0.1.0",
        "ip":"10.0.1.12",
        "netmask":"255.255.0.0",
        "gateway":"10.0.0.1"
    ],
}
```

## API Reference

The canonical endpoint catalog lives in `openapi.yaml`.

A browsable version is available at https://bump.sh/nethvoice/hub/nethvoice/doc/wizard/

### Authentication

Each request must include two HTTP headers:

- `User`: must be a valid FreePBX administrator (ampusers table)
- `Secretkey`: must be a valid hash

The Secretkey must be calculated using the following parameters:

- user: the same value of `User` header
- password: password of the user in sha1 hash format
- secret: shared static secret between client and server; default is: `1234`

Javascript example:

```
<script type="text/javascript" src="rest/sha1.js"></script>
<script type="text/javascript">

var user = "admin";
var password = sha1("admin");
var secret = "1234";
var hash = sha1(user + password + secret);

console.log("Secretkey: " + hash);

</script>
```

Generate the secret key from bash:

```
user=admin;
pass=admin;
secret=$(cat /var/lib/nethserver/secrets/nethvoice); \
pass=$(echo -n $pass | sha1sum | awk '{print $1}'); \
echo -n $user$pass$secret | sha1sum | awk '{print $1}'
```






